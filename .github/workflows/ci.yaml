name: CI/CD —Å —Ç–µ—Å—Ç–∞–º–∏

on:
  push:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - uses: actions/setup-node@v4
      with:
        node-version: '18'

    - run: npm install

    - name: Run tests and generate results
      run: |
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        npm test

    - name: Update README with test results
      run: |
        # –ü–∞—Ä—Å–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤ –∏ —Å–æ–∑–¥–∞–µ–º —Å–µ–∫—Ü–∏—é –¥–ª—è README
        node << 'EOF'
        const fs = require('fs');

        // –ß–∏—Ç–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤
        let results;
        try {
          results = JSON.parse(fs.readFileSync('test-results.json', 'utf8'));
        } catch (e) {
          console.error('Failed to read test results:', e);
          process.exit(1);
        }

        // –ß–∏—Ç–∞–µ–º —Ç–µ–∫—É—â–∏–π README
        let readme = fs.readFileSync('README.md', 'utf8');

        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å–µ–∫—Ü–∏—é —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ —Ç–µ—Å—Ç–æ–≤
        const testSectionRegex = /<!-- TEST_RESULTS_START -->[\s\S]*<!-- TEST_RESULTS_END -->/;
        readme = readme.replace(testSectionRegex, '');

        // –§–æ—Ä–º–∏—Ä—É–µ–º –Ω–æ–≤—É—é —Å–µ–∫—Ü–∏—é —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
        const date = new Date().toLocaleString('ru-RU', { timeZone: 'UTC' });
        let testSection = '<!-- TEST_RESULTS_START -->\n';
        testSection += '## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤\n\n';
        testSection += `**–ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—É—Å–∫:** ${date} UTC\n\n`;

        // –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        const passed = results.numPassedTests;
        const failed = results.numFailedTests;
        const total = results.numTotalTests;
        const allPassed = results.success;

        testSection += `**–°—Ç–∞—Ç—É—Å:** ${allPassed ? '‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã' : '‚ùå –ï—Å—Ç—å –æ—à–∏–±–∫–∏'}\n\n`;
        testSection += `**–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤:** ${total} | ‚úÖ –ü—Ä–æ–π–¥–µ–Ω–æ: ${passed} | ‚ùå –ü—Ä–æ–≤–∞–ª–µ–Ω–æ: ${failed}\n\n`;

        // –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –≥—Ä—É–ø–ø–∞–º
        testSection += '### –î–µ—Ç–∞–ª–∏ –ø–æ —Ç–µ—Å—Ç–∞–º:\n\n';
        testSection += '| –¢–µ—Å—Ç | –°—Ç–∞—Ç—É—Å |\n';
        testSection += '|------|--------|\n';

        if (results.testResults) {
          for (const suite of results.testResults) {
            for (const test of suite.assertionResults) {
              const status = test.status === 'passed' ? '‚úÖ' : '‚ùå';
              const testName = test.ancestorTitles.join(' > ') + ' > ' + test.title;
              testSection += `| ${testName} | ${status} |\n`;
            }
          }
        }

        testSection += '<!-- TEST_RESULTS_END -->';

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–∫—Ü–∏—é –≤ –∫–æ–Ω–µ—Ü README
        readme = readme.trim() + '\n\n' + testSection;

        // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π README
        fs.writeFileSync('README.md', readme);
        console.log('README.md updated with test results');
        EOF

    - name: Update CHANGELOG.md
      run: |
        # –°–æ–∑–¥–∞–µ–º changelog
        echo "# Changelog" > CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "Updated: $(date)" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "| Commit | Date | Author | Message |" >> CHANGELOG.md
        echo "|--------|------|--------|---------|" >> CHANGELOG.md

        git log --pretty=format:"| %h | %ad | %an | %s |" --date=short >> CHANGELOG.md

    - name: Commit and push changes
      run: |
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git config user.name "github-actions[bot]"

        git add README.md CHANGELOG.md
        git commit -m "üß™ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–æ–≤ –∏ changelog" 2>/dev/null || echo "No changes to commit"
        git push || echo "Nothing to push"
