name: Простой CI/CD

on:
  push:
    branches: [ main, master ]

jobs:
  ci:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Важно! Получаем ВСЮ историю коммитов
    
    - uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - run: npm install
    
    - run: node test.js
    
    - name: Создать CHANGELOG.md с полной историей
      run: |
        echo "# История изменений проекта" > CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "## Последнее обновление: $(date '+%Y-%m-%d %H:%M:%S')" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### Все коммиты в репозитории:" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        
        # Получаем ВСЕ коммиты
        echo "| Хэш | Дата | Автор | Сообщение |" >> CHANGELOG.md
        echo "|------|------|-------|-----------|" >> CHANGELOG.md
        
        # Форматируем коммиты в таблицу
        git log --pretty=format:"| %h | %ad | %an | %s |" --date=short >> CHANGELOG.md
        
        echo "" >> CHANGELOG.md
        echo "---" >> CHANGELOG.md
        echo "*Файл обновляется автоматически при каждом коммите*" >> CHANGELOG.md
        
        echo "=== Файл CHANGELOG.md создан ==="
        echo "Количество строк:"
        wc -l CHANGELOG.md
    
    - name: Показать первые 15 строк changelog
      run: |
        echo "=== Начало CHANGELOG.md ==="
        head -15 CHANGELOG.md
        echo "=== ... ==="
    
    - name: Сохранить CHANGELOG.md как артефакт
      uses: actions/upload-artifact@v4
      with:
        name: changelog
        path: CHANGELOG.md
        retention-days: 30